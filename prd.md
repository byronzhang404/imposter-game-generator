# 🎭 「谁是卧底」核心版游戏网站产品设计方案

## 一、产品概述

### 1.1 产品定位
「谁是卧底」是一款经典的多人社交推理游戏。本项目旨在构建一个 **轻量级、无社交冗余功能** 的网页版本，专注于核心玩法环节的流畅实现，包括房间管理、词语分配、局势推进与游戏胜负判断。

### 1.2 产品目标
- 支持玩家在线创建房间并邀请他人加入。
- 支持主持人进行词语分配与局势控制。
- 系统自动辅助判定游戏是否结束。
- 房间不变的情况下，一键开启下一局
- 支持多语言，默认显示英文

---

## 二、核心功能设计

### 2.1 用户角色

| 角色 | 权限与功能 |
|------|-------------|
| **主持人（Host）** | 创建房间、分配词语、控制游戏阶段、确定被淘汰玩家、判断游戏结束、重新开局 |
| **玩家（Player）** | 加入房间、查看词语、参与讨论与投票（线下）、等待主持人操作下一步 |

---

## 三、游戏流程设计

### 3.1 游戏整体流程

1. **创建房间**
   - 主持人点击“创建房间”按钮。
   - 系统生成一个唯一的房间 ID。
   - 主持人分享房间 ID 或二维码邀请玩家。

2. **加入房间**
   - 玩家输入房间 ID 加入游戏。
   - 玩家输入昵称后进入房间等待界面。
   - 房间实时显示所有玩家列表

3. **分配词语**
   - 主持人点击“开始游戏”，开始一局游戏
   - 系统随机选择一组近义词，如：「苹果 / 香蕉」。
   - 系统随机选择1名卧底（默认 1 名，可配置）。
   - 系统分别分配：
     - 普通玩家：词语 A
     - 卧底玩家：词语 B

4. **线下讨论与投票**
   - 所有玩家线下描述自己的词语。
   - 线下投票产生被淘汰者。
   - 主持人在系统中手动选择本轮被淘汰的玩家并确认其身份。

5. **系统判定游戏是否结束**
   - 若卧底出局 → 平民胜利，本局游戏结束；
   - 若当前轮次剩余人数<=3人 → 卧底胜利，本局游戏结束；
   - 否则 → 下一轮继续。

6. **重新开局**
   - 当本局游戏结束后，主持人可以点击“重新开始”按钮。
   - 系统重新分配词语并开始下一局。

> 解释说明：
> 局：系统随机分配词语给玩家代表一局游戏的开始，当卧底出局或当前轮次剩余人数<=3人时，本局游戏结束；本局游戏结束后，主持人可以在当前房间开始下一局游戏；
> 轮：每局游戏包含多轮，每一轮中未被淘汰的玩家依次发言，所有未被淘汰的玩家发言结束后，进行投票，确定本轮淘汰谁；
---

## 四、系统架构设计

### 4.1 技术栈

| 层级 | 技术 |
|------|------|
| 前端框架 | Next.js 15 (App Router) |
| 后端服务 | Supabase (Auth + Database + Realtime) |
| UI 库 | Tailwind CSS + shadcn/ui |
| 状态管理 | React Context / Zustand |
| 部署 | Vercel + Supabase Cloud |

---

## 五、数据库设计（Supabase Schema）

### 5.1 表结构概览

#### `rooms` 房间表
| 字段 | 类型 | 描述 |
|------|------|------|
| id | uuid (PK) | 房间唯一 ID |
| host_id | uuid | 主持人用户 ID |
| status | text | 房间状态：`waiting` / `playing` / `finished` |
| created_at | timestamp | 创建时间 |

#### `players` 玩家表
| 字段 | 类型 | 描述 |
|------|------|------|
| id | uuid (PK) | 玩家 ID |
| room_id | uuid (FK) | 所在房间 |
| name | text | 玩家昵称 |
| created_at | timestamp | 加入时间 |

#### `rounds` 游戏局表，每一行代表一局游戏
| 字段 | 类型 | 描述 |
|------|------|------|
| id | uuid (PK) | 回合 ID |
| room_id | uuid (FK) | 所属房间 |
| round_number | int | 局编号，从 1 开始 |
| normal_word| text | 普通玩家词语 |
| undercover_word| text | 卧底玩家词语 |
| undercover_player_ids | uuid[] | 卧底玩家列表 |
| eliminated_player_ids | uuid[] | 本局已被淘汰玩家列表 |
| winner_side | text | 胜利方：`normal` / `undercover` |
| status | text | 回合状态：`ongoing` / `finished` |
| created_at | timestamp | 时间戳 |
| last_updated_at | timestamp | 最后更新时间 |

---

## 六、前端交互设计（页面结构）

### 6.1 页面结构
/ (Home)
├─ /create → 主持人创建房间页
├─ /room/[id] → 游戏房间页（实时状态）


### 6.2 界面模块

| 页面 | 功能点 |
|------|--------|
| **首页** | 选择“创建房间”或“加入房间” |
| **创建房间页** | 输入昵称 → 创建房间 → 显示房间号与邀请链接 |
| **房间页** | 实时显示玩家列表、房间状态；加入动作 ;主持人控制游戏流程 |
---

## 七、核心交互逻辑

### 7.1 房间实时同步（Supabase Realtime）
- 监听 `players` 表变更 → 实时更新玩家列表。
- 监听 `rooms` 表的状态字段 → 控制前端界面切换（等待、游戏中、已结束）

### 7.2 游戏控制（仅主持人）
- ”创建房间“ → 主持人点击“创建房间”按钮，系统生成一个唯一的房间 ID 并分享给玩家
- “开始游戏” → 更新房间状态为 `playing`，并创建第一局游戏记录，向玩家分配词语
- “淘汰玩家” → 选定本轮被淘汰玩家，追加到 rounds表的`eliminated_player_ids`字段。
- “判定胜负” → 自动检测本轮剩余人数与身份关系
- ”开启下一局“：上一局结束的情况下，主持人可以重新触发词语分配，从而开启下一局游戏

### 7.3 游戏过程
- 加入游戏 → 普通玩家点击分享链接进入房间；房间状态为 `waiting`时，玩家进入等待列表（支持修改昵称）；否则提示房间已开始，无法加入
- 查看词语 → 所有玩家均可以查看本局分配给自己的词语。词语默认打码显示，点击显示按钮时才会明文显示，按钮松开后继续打码显示
---

## 八、权限与安全设计

- 主持人通过房间创建时获得 host_token。
- 普通玩家仅能查看自己词语、房间状态、当前玩家列表。
- Supabase 行级安全（RLS）策略：
  - 仅主持人可修改房间状态；
  - 所有更新动作需验证 `auth.uid()`。

---

## 九、附录

### 9.1 示例词语对
["苹果","香蕉"], ["猫","狗"], ["老师","教授"], ["海","湖"], ["火车","地铁"]



### 9.2 示例交互
主持人A创建房间 → 邀请B、C、D加入 → 点击开始 → 系统分配词语
→ 线下讨论投票 → 主持人标记C被淘汰（卧底）→ 系统判定平民胜利 → 新局开始

